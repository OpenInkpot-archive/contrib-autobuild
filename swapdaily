#!/bin/bash
set -e

WORKDIR=$(mktemp -d)
TARGETDIR=/srv/www/openinkpot.org/htdocs/pub/daily/
SUBJECT="OI: Daily builds report"
RECIPIENT="dottedmag@dottedmag.net"

send_mail(){
	df -h >> ${WORKDIR}/report
	mail $SUBJECT $RECIPIENT < ${WORKDIR}/report
}

create_html(){
	cd $WORKDIR
cat <<EOF >index.html
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"> 
<html>
<head>
<title>OpenInkpot's daily builds</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
</head>
<h1>OpenInkpot's daily builds</h1>
<table border="1">
<tr><th>name</th><th>size</th><th>md5</th><th>sha1</th></tr>
EOF
	for col in $(ls *.zip); do
		echo -n "<tr><td><a href=\"${col}\">${col}</a></td><td>" >> index.html
		stat -c %s ${col} >> index.html
		echo -n "</td><td>" >> index.html
		grep $col MD5SUMS | cut -d ' ' -f 1 >> index.html
		echo -n "</td><td>" >> index.html
		grep $col SHA1SUMS | cut -d ' ' -f 1 >> index.html
		echo -n "</td></tr>" >> index.html
	done
	echo "</table>" >> index.html
	echo "</html>" >> index.html
}

rsync -ar 'ab:output/*/*' $WORKDIR
ssh ab rm -rf output

if [ -a ${WORKDIR}/report ]; then
	# if something was fetched at all
	if [ -s ${WORKDIR}/report ]; then
		#if there was no single build error
		rm -f ${TARGETDIR}*
		mv ${WORKDIR}/*.zip ${WORKDIR}/index.html $TARGETDIR
		echo "Files were moved to pub/daily" >> ${WORKDIR}/report
	else
		#if there were errors
		echo "Some errors occured during building fw. Not swapping daily" >> ${WORKDIR}/report
	fi
	send_mail
else
	# if fetching failed
	echo "Fetching build files failed!" > ${WORKDIR}/report
	send_mail
fi

rm -rf "$WORKDIR"
