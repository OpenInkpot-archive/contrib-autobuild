#!/bin/sh
set -e

WORKDIR=$(mktemp -d  $HOME/buildfw.XXXXXXXX)

cd $WORKDIR

wget -c -t0 http://ftp.iplinux.org/contrib/iplinux-bootstrap/iplinux-bootstrap-LATEST.tar.bz2
tar xf iplinux-bootstrap-LATEST.tar.bz2
cd iplinux-bootstrap-*
./iplinux-bootstrap --debian-mirror=http://localhost:9999/debian/ openinkpot ../buildroot
cd ..

buildroot/enter sh -c 'sudo apt-get install --yes --force-yes oi-build-firmware'

buildroot/enter sh -c "cat /dev/null > report"
buildroot/enter sh -c "build-fw n516 --variant=azbooka $1 || echo 'azbooka516 failed' >> report"
buildroot/enter sh -c "build-fw n516 $1 || echo 'hanvon-n516 failed' >> report"
buildroot/enter sh -c "build-fw v3 $1 || echo 'v3-install failed' >> report"
buildroot/enter sh -c "build-fw v3 --mode=live $1 || echo 'v3all-live failed' >> report"
buildroot/enter sh -c "build-fw v3 --mode=nfsroot $1 || echo 'v3-nfsroot failed' >> report"
buildroot/enter sh -c "build-fw v3ext $1 || echo 'v3ext-install failed' >> report"

cd buildroot/build/output/*
md5sum oi-* azbooka* > MD5SUMS
sha1sum oi-* azbooka* > SHA1SUMS
cd $WORKDIR
cp -a buildroot/build/output ~

cd

sudo rm -rf "$WORKDIR"
